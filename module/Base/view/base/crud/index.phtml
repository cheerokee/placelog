<?php
/**
 * @var \Base\Controller\BaseFunctions $functions
 */
$functions = new \Base\Controller\BaseFunctions();

function camel2dashed($className) {
    return strtolower(preg_replace('/([^A-Z-])([A-Z])/', '$1-$2', $className));
}
$controller = camel2dashed($this->_listView['controller']);

$link['new'] = $this->url($this->_listView['route'], array(
    'controller' => $controller,
    'action' => 'new'
));

$chave = $this->_listView['controller'];

//Preferencia de redirecionamento
if(isset($goto[$chave])){
	if(!$this->personPermission('modulos',$this->_listView['controller'],'listAll')) {
		header('Location: '.$goto[$chave]);
		exit();
	}
}else{
	if(!$this->personPermission('modulos',$this->_listView['controller'],'listAll')) {
		header('Location: /not-have-permission');
		exit();
	}
}

$db_profile = $this->getEm()->getRepository('Register\Entity\Profile')->findOneByChave($chave);
if($db_profile instanceof \Register\Entity\Profile)
{
    $param = 'profile=' . $db_profile->getChave();
}

$entity = $this->entity;
$em = $this->getEm();

$fk = $this->fk;
$fk_id = $this->fk_id;

$url_new = null;
if($fk != null && $fk_id != null)
{
    $url_new = $this->url($controller.'-join-new',array('fk' => $fk,'fk_id' => $fk_id));
}else{
    $url_new = $this->url($this->_listView['route'],array('action'=>'new'));
}

?>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <ol class="breadcrumb">
                <li><a href="/admin"><i class="fa fa-dashboard"></i> Home</a></li>
                <li class="active"><?=$this->_listView['title']?></li>
            </ol>
            <?php $this->getAdminFlashMessenger();?>
        </div>
        <?=$this->partial('filter-base',array(
            'em' => $em,
            'controller' => $controller,
            'listView' => $this->_listView,
            'entity' => $this->entity,
            'form'  => $this->form,
        ));?>
        <?php
        if($fk != null && $fk_id != null){
            ?>
            <div class="col-md-12">
                <h4>
                    <a href="<?=$this->url($this->fk_route,array('controller' => $fk,'action' => 'edit','id' => $fk_id))?>">
                        Cod.: <?=$this->fk_entity->getId();?> <?=$this->fk_entity;?>
                    </a>
                </h4>
            </div>
            <?php
        }
        ?>

        <div class="col-md-12">
            <div class="card">
                <div class="header">
                    <div class="row">
                        <div class="col-md-8">
                            <h4 class="title">
                                <?=$this->_listView['title']?> - <small>Listagem de Registros</small>
                            </h4>
                        </div>
                        <div class="col-md-4">
                            <div style="float: right; margin-right: 10px;" class="btn-group">
                                <a href="<?php echo $url_new ?>?<?=$param?>">
                                    <button type="button" class="btn btn-success">
                                        <i class="fa fa-plus"></i> Novo
                                    </button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="content">
                    <div class="row">
                        <div class="col-md-12">
                            <?php
                            $method_filter = 'filter'.ucwords($controller);
                            try{
                                echo $this->$method_filter();
                            }catch (Exception $e){}


                            ?>
                            <table class="table table-hover">
                                <?=$this->partial('partial/header');?>
                                <?=$this->partial('partial/body',array('controller' => $controller,'data' => $data,'param' => $param,'em' => $em,'fk' => $fk,'fk_id' => $fk_id));?>
                            </table>
                        </div>
                        <div class="col-md-12">
                            <?=$this->paginationControl($this->data,'Sliding','partials/paginator'); ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


